<!DOCTYPE html>
<html>
<head>
  <title>Facemoji</title>
  <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/main.css') }}">
</head>
<body>
  <h1>Hi, welcome to Facemoji!</h1>
  <video id="video" width="640" height="480" autoplay></video>
  <canvas id="canvas" style="display:none;"></canvas>
  <br>
  <button id="capture">Capture & Upload</button>

  <p id="status"></p>
  <p id="timestamp"></p>
  <p id="docId"></p>

  <script>
    window.onload = () => {
      const video = document.getElementById("video");
      const canvas = document.getElementById("canvas");
      const statusText = document.getElementById("status");
      const timestampText = document.getElementById("timestamp");
      const docIdText = document.getElementById("docId");

      navigator.mediaDevices.getUserMedia({ video: true })
        .then(stream => {
          video.srcObject = stream;
        })
        .catch(err => {
          statusText.textContent = "Camera error: " + err.message;
        });

      document.getElementById("capture").onclick = async () => {
        const ctx = canvas.getContext("2d");
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

        const base64Image = canvas.toDataURL("image/jpeg");

        try {
          const res = await fetch("/upload", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ image: base64Image })
          });

          const result = await res.json();

          if (result.status) {
            statusText.textContent = result.status;
            timestampText.textContent = "Uploaded at: " + result.timestamp;
            docIdText.textContent = "Document ID: " + result.id;
          } else {
            statusText.textContent = "Error: " + result.error;
            timestampText.textContent = "";
            docIdText.textContent = "";
          }
        } catch (err) {
          statusText.textContent = "Upload failed: " + err.message;
          statusText.style.color = "red";
        }
      };
    };
  </script>
</body>
</html>
